<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Business Owner Sign Up - Black Service Spot</title>
  <meta name="description" content="Register your business on Black Service Spot. Choose a plan, add your details, and subscribe via PayPal."/>
  <style>
    :root{--g1:#10b981;--g2:#059669;--g3:#047857;--bg:#f9fafb;--text:#111827;--muted:#6b7280;--card:#ffffff;--ring:#10b981;--border:#e5e7eb;}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
    header{background:#fff;position:sticky;top:0;z-index:20;border-bottom:1px solid #f0f0f0}
    .nav{max-width:1100px;padding:.75rem 1rem;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:.5rem;color:#059669;font-weight:800}
    .main{min-height:100vh;background:linear-gradient(135deg,var(--g1),var(--g2) 50%,var(--g3));padding:2rem 1rem 3rem;display:flex;align-items:flex-start;justify-content:center}
    .card{width:100%;max-width:1000px;background:var(--card);border-radius:1rem;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden}
    .card-header{background:linear-gradient(135deg,#6ee7b7,#34d399 50%,#10b981);color:#064e3b;padding:1.25rem}
    .card-header h1{margin:0;font-size:1.4rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .section{padding:1.25rem}
    .section h2{font-size:1.1rem;margin:0 0 .75rem 0;color:#064e3b}
    label{font-weight:600;display:block;margin:.5rem 0 .35rem;color:#374151}
    input[type="text"],input[type="email"],input[type="file"],select,textarea{width:100%;padding:.7rem .8rem;border:2px solid var(--border);border-radius:.6rem;outline:none;background:#fff;font-size:.95rem;transition:border-color .2s,box-shadow .2s}
    textarea{min-height:90px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(16,185,129,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .btn{border:none;padding:.75rem 1rem;border-radius:.6rem;font-weight:700;cursor:pointer}
    .btn-primary{background:#10b981;color:#fff}
    .btn-secondary{background:transparent;color:#10b981;border:2px solid #10b981}
    .muted{color:var(--muted);font-size:.9rem}
    .pay-wrap{margin-top:1rem;border:1px dashed #d1fae5;background:#f0fdf4;border-radius:.75rem;padding:1rem}
    .pill{display:inline-block;padding:.25rem .5rem;background:#ecfdf5;color:#065f46;border-radius:999px;font-size:.75rem;margin-left:.5rem}
    @media (max-width: 840px){.grid{grid-template-columns:1fr}.row{grid-template-columns:1fr}}
  </style>
  <!-- PayPal SDK: visible buttons -->
  <script src="https://www.paypal.com/sdk/js?client-id=EPnN8sfzHMua72kW2vyRp2nLph-ManxYnzSkHflGbkFlhqkSef8KMNuOG-3WxLKxpWbWBwPFnGRLskxB&vault=true&intent=subscription"></script>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2 13.09 8.26 22 9l-8.91.74L12 16 10.91 9.74 2 9l8.91-.74L12 2z"/></svg>
        Black Service Spot — Business Registration
      </div>
      <div><a href="index.html" class="muted" style="text-decoration:none;">← Back to Home</a></div>
    </div>
  </header>

  <main class="main">
    <div class="card">
      <div class="card-header"><h1>Register Your Business</h1></div>

      <form id="signupForm" class="section" autocomplete="on">
        <div class="grid">
          <section>
            <h2>Your Details</h2>
            <label for="ownerName">Your Name</label>
            <input id="ownerName" type="text" required/>
            <label for="businessName">Business Name</label>
            <input id="businessName" type="text" required/>
            <label for="email">Email</label>
            <input id="email" type="email" required/>
            <label for="phone">Phone</label>
            <input id="phone" type="text" placeholder="(555) 555-5555"/>

            <div class="row">
              <div>
                <label for="stateSelect">State</label>
                <select id="stateSelect" required>
                  <option value="" disabled selected>Select State</option>
                </select>
              </div>
              <div>
                <label for="citySelect">City</label>
                <select id="citySelect" required disabled>
                  <option value="" disabled selected>Select City</option>
                </select>
              </div>
            </div>

            <label for="address">Business Address <span class="muted">(optional)</span></label>
            <input id="address" type="text" placeholder="123 Main St"/>

            <label for="businessType">Business Type</label>
            <input id="businessType" type="text" placeholder="Barber, Caterer, Consultant..." required/>

            <label for="services">Services <span class="muted">(comma-separated)</span></label>
            <textarea id="services" placeholder="Braids, Locs, Silk Press"></textarea>

          </section>

          <section>
            <h2>Plan & Payment</h2>
            <label for="planSelect">Choose Plan <span class="pill">$4.95 setup</span></label>
            <select id="planSelect" required>
              <option value="monthly">Monthly — $29.95</option>
              <option value="annual">Annual — $287.52 (20% off)</option>
            </select>

            <div class="pay-wrap">
              <p class="muted" style="margin-top:0">1) Fill the form • 2) Click the PayPal button below • 3) Approve subscription • 4) You’ll be redirected to your dashboard.</p>
              <div id="paypal-monthly" style="display:none"></div>
              <div id="paypal-annual" style="display:none"></div>
              <p id="payMsg" class="muted" style="margin-top:.5rem;"></p>
            </div>

            <div style="margin-top:1rem">
              <button id="prepBtn" type="button" class="btn btn-primary">Save & Show PayPal Button</button>
              <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
            </div>

            <!-- Hidden sync for Firestore convenience -->
            <input type="hidden" id="stateHidden"/>
            <input type="hidden" id="cityHidden"/>
          </section>
        </div>
      </form>
    </div>
  </main>

  <!-- Firebase (v10 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDHROoVHEPvBSo7ZXGZB2xf7Wnb_U9SErs",
      authDomain: "black-service-spot.firebaseapp.com",
      projectId: "black-service-spot",
      storageBucket: "black-service-spot.firebasestorage.app",
      messagingSenderId: "707361777966",
      appId: "1:707361777966:web:f41f3276b26d5dca50b2bf",
      measurementId: "G-HDD97PF8K7"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Expose save function to window so PayPal (non-module) can call it
    window.BSS = window.BSS || {};
    window.BSS.saveRegistration = async function saveRegistration(){
      const $ = id => document.getElementById(id);
      const ownerName  = $("ownerName").value.trim();
      const business   = $("businessName").value.trim();
      const email      = $("email").value.trim();
      const phone      = $("phone").value.trim();
      const state      = $("stateHidden").value || $("stateSelect").value;
      const city       = $("cityHidden").value  || $("citySelect").value;
      const address    = $("address").value.trim();
      const businessType = $("businessType").value.trim();
      const services   = $("services").value.split(",").map(s=>s.trim()).filter(Boolean);
      const plan       = $("planSelect").value;

      if(!ownerName || !business || !email || !state || !city || !businessType){
        throw new Error("Please complete all required fields (Name, Business, Email, State, City, Business Type).");
      }

      const docId = business.trim().toLowerCase().replace(/[^\w\- ]+/g,"").replace(/\s+/g,"-");
      await setDoc(doc(db, "Business_owners", docId), {
        ownerName, businessName: business, email, phone, state, city, address,
        businessType, services, plan, createdAt: serverTimestamp()
      }, { merge: true });

      return { docId, plan };
    };
  </script>

  <!-- Inline Cities dataset + connector (short list for demo; keep your current one if already working) -->
  <script>
    window.CITIES_BY_STATE = window.CITIES_BY_STATE || {
      "Georgia": ["Atlanta","Augusta","Savannah","Columbus","Macon","Athens"],
      "Louisiana": ["Baton Rouge","Bossier City","Kenner","Lafayette","Lake Charles","New Orleans","Shreveport"],
      "Texas": ["Houston","Dallas","Austin","San Antonio","Fort Worth","Plano","Arlington"]
    };
    (function(){
      const stateEl = document.getElementById('stateSelect');
      const cityEl  = document.getElementById('citySelect');
      const hiddenState = document.getElementById('stateHidden');
      const hiddenCity  = document.getElementById('cityHidden');

      // populate states
      Object.keys(CITIES_BY_STATE).sort().forEach(name=>{
        const opt=document.createElement('option'); opt.value=name; opt.textContent=name; stateEl.appendChild(opt);
      });
      function resetCity(){
        cityEl.innerHTML=''; const ph=document.createElement('option');
        ph.value=''; ph.textContent='Select City'; ph.disabled=true; ph.selected=true; cityEl.appendChild(ph); cityEl.disabled=true;
      }
      function populateCities(stateName){
        resetCity();
        const list=(CITIES_BY_STATE[stateName]||[]).slice().sort();
        list.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cityEl.appendChild(o); });
        if(list.length){ cityEl.disabled=false; }
        syncHidden();
      }
      function syncHidden(){ hiddenState.value = stateEl.value || ''; hiddenCity.value = cityEl.value || ''; }
      stateEl.addEventListener('change', ()=>{ populateCities(stateEl.value); });
      cityEl.addEventListener('change', syncHidden);
      resetCity();
    })();
  </script>

  <!-- PayPal button rendering + flow -->
  <script>
    const MONTHLY_PLAN_ID = "P-37739232P6875371KNB7M33A";
    const ANNUAL_PLAN_ID  = "P-6VE96793E07454030NB7M7IA";

    const payMonthly = document.getElementById('paypal-monthly');
    const payAnnual  = document.getElementById('paypal-annual');
    const planSelect = document.getElementById('planSelect');
    const payMsg     = document.getElementById('payMsg');
    const prepBtn    = document.getElementById('prepBtn');

    // Render both buttons (hidden); we let user choose plan to show the right one
    function renderButtons(){
      if (window.paypal && !payMonthly.hasChildNodes()) {
        paypal.Buttons({
          style: { layout: 'vertical', label: 'subscribe' },
          onClick: async () => {
            payMsg.textContent = "Saving your info...";
            try{
              const { docId } = await window.BSS.saveRegistration();
              sessionStorage.setItem('bss_doc', docId);
              payMsg.textContent = "Opening PayPal...";
            }catch(e){ payMsg.textContent = e.message || "Please complete required fields."; throw e; }
          },
          createSubscription: (data, actions) => actions.subscription.create({ plan_id: MONTHLY_PLAN_ID }),
          onApprove: () => {
            const id = sessionStorage.getItem('bss_doc') || '';
            window.location.href = "success.html?business=" + encodeURIComponent(id);
          },
          onError: (err) => { console.error(err); payMsg.textContent = "PayPal error. Try again."; }
        }).render('#paypal-monthly');
      }
      if (window.paypal && !payAnnual.hasChildNodes()) {
        paypal.Buttons({
          style: { layout: 'vertical', label: 'subscribe' },
          onClick: async () => {
            payMsg.textContent = "Saving your info...";
            try{
              const { docId } = await window.BSS.saveRegistration();
              sessionStorage.setItem('bss_doc', docId);
              payMsg.textContent = "Opening PayPal...";
            }catch(e){ payMsg.textContent = e.message || "Please complete required fields."; throw e; }
          },
          createSubscription: (data, actions) => actions.subscription.create({ plan_id: ANNUAL_PLAN_ID }),
          onApprove: () => {
            const id = sessionStorage.getItem('bss_doc') || '';
            window.location.href = "success.html?business=" + encodeURIComponent(id);
          },
          onError: (err) => { console.error(err); payMsg.textContent = "PayPal error. Try again."; }
        }).render('#paypal-annual');
      }
    }

    // Toggle which PayPal button is visible
    function showSelectedButton(){
      const plan = planSelect.value;
      payMonthly.style.display = (plan === 'monthly') ? 'block' : 'none';
      payAnnual.style.display  = (plan === 'annual')  ? 'block' : 'none';
    }
    planSelect.addEventListener('change', showSelectedButton);

    // User clicks "Save & Show PayPal Button"
    prepBtn.addEventListener('click', async () => {
      try{
        // Validate required fields before showing buttons
        await window.BSS.saveRegistration();
        payMsg.textContent = "Saved ✔ Now choose the PayPal button below.";
        renderButtons();
        showSelectedButton();
      }catch(e){
        payMsg.textContent = e.message || "Please complete all required fields.";
      }
    });

    // Initial
    renderButtons();
    showSelectedButton();
  </script>
</body>
</html>
